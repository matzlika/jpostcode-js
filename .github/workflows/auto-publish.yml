name: Auto Publish to npm on Submodule Update

on:
  schedule:
    - cron: "0 2 * * *"  # Runs daily at 2 AM UTC
  workflow_dispatch:  # Allows manual trigger
  push:
    paths:
      - "submodule-path/**"  # Replace with your actual submodule path
    branches:
      - main

jobs:
  check-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Check for submodule updates
        id: check_submodule
        run: |
          git submodule update --remote
          if [[ -n $(git diff --submodule) ]]; then
            echo "Submodule changed"
            echo "SUBMODULE_CHANGED=true" >> $GITHUB_ENV
          else
            echo "No updates detected"
            echo "SUBMODULE_CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Configure Git
        if: env.SUBMODULE_CHANGED == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"

      - name: Set package.json version to date-based format
        if: env.SUBMODULE_CHANGED == 'true'
        run: |
          NEW_VERSION=$(date +'%Y%m%d%H%M%S')
          jq --arg v "$NEW_VERSION" '.version = $v' package.json > temp.json && mv temp.json package.json
          echo "Updated package.json version to $NEW_VERSION"

      - name: Commit & Push Changes
        if: env.SUBMODULE_CHANGED == 'true'
        run: |
          git add package.json
          git commit -m "Updated package.json version to $(date +'%Y%m%d%H%M%S') due to submodule update"
          git push origin main

      - name: Tag the repository with the timestamp
        if: env.SUBMODULE_CHANGED == 'true'
        run: |
          TAG_NAME="submodule-update-$(date +'%Y%m%d%H%M%S')"
          git tag -a "$TAG_NAME" -m "Submodule updated on $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin "$TAG_NAME"

      - name: Publish to npm
        if: env.SUBMODULE_CHANGED == 'true'
        run: |
          npm config set //registry.npmjs.org/:_authToken=$NPM_TOKEN
          npm publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
